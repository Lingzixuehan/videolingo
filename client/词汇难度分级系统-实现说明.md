# 词汇难度分级与过滤系统 - 实现说明

## 📌 任务概述

**任务名称**: 词汇难度分级与过滤系统
**关联需求**: SRS 3.1.1 功能需求 - 字幕获取及其分析模块

---

## 🎯 实现目标

实现一个智能词汇难度分级系统，能够：

1. ✅ 根据用户设定的词汇量水平（CET4/CET6/TOEFL等）自动标注超纲词汇
2. ✅ 为每个单词添加难度标签（如"四级词汇"、"托福词汇"）
3. ✅ 生成个性化的生词列表，包含词汇释义和首次出现位置
4. ✅ 统计词汇覆盖率，帮助用户了解学习材料的难度

---

## 📂 文件改动清单

### 新增文件

#### 1. `vocab_level.py` - 词汇难度分级核心模块
**路径**: `D:\videolingo\videolingo\front\src\common\whisper\vocab_level.py`

**功能**:
- 定义词汇量等级体系（BASIC → CET4 → CET6 → TOEFL → IELTS → GRE → ADVANCED）
- 实现 `VocabLevelChecker` 类，提供难度判断逻辑
- 支持基于标签（tag）和词频（BNC/FRQ）的双重判断机制

**核心类**:
```python
class VocabLevelChecker:
    def __init__(self, user_level: VocabLevel)
    def is_beyond_level(self, word: str, word_entry: dict) -> bool
    def get_difficulty_label(self, word: str, word_entry: dict) -> str
```

**关键特性**:
- 支持层次化词汇等级（高级包含低级）
- 常用词白名单（~1000词，不标注）
- 无标签词汇自动使用词频判断

---

#### 2. `test_vocab_level.py` - 测试用例
**路径**: `D:\videolingo\videolingo\front\src\common\whisper\test_vocab_level.py`

**功能**:
- 测试不同用户等级的词汇判断
- 验证标签解析功能
- 测试词频判断逻辑
- 展示输出 JSON 结构示例

**运行方式**:
```bash
cd D:\videolingo\videolingo\front\src\common\whisper
python test_vocab_level.py
```

---

### 修改文件

#### 3. `label.py` - 字幕标注主程序（已扩展）
**路径**: `D:\videolingo\videolingo\front\src\common\whisper\label.py`

**改动点**:

##### 改动 1: 导入词汇难度模块
```python
# 第13-22行：添加导入
from vocab_level import VocabLevelChecker, VocabLevel, get_level_from_string
```

##### 改动 2: 扩展 Labeler 构造函数
```python
# 第60-79行：添加 user_vocab_level 参数
def __init__(self, dict_csv_path: str = None, user_vocab_level: str = 'cet4'):
    # 初始化词汇难度检查器
    self.level_checker = VocabLevelChecker(vocab_level)
```

##### 改动 3: 增强单词标注逻辑
```python
# 第183-225行：为每个单词添加难度信息
word_info = {
    'original': key,
    'entry': entry,
    'is_new': is_new_word,      # 新增：是否超纲
    'difficulty': difficulty_label  # 新增：难度标签
}
```

##### 改动 4: 扩展 word_map 结构
```python
# 第199-212行：记录词汇出现位置
word_map[word_key] = {
    'entry': entry,
    'is_new': is_new_word,
    'difficulty': difficulty_label,
    'occurrences': [...]  # 新增：记录该词在哪些句子中出现
}
```

##### 改动 5: 生成生词列表
```python
# 第214-225行：提取超纲词汇
new_words.append({
    'word': entry.get('word') or tok,
    'translation': entry.get('translation', ''),
    'difficulty': difficulty_label,
    'first_occurrence': {...}  # 首次出现的位置
})
```

##### 改动 6: 添加统计信息
```python
# 第240-245行：在输出 JSON 中添加统计
'statistics': {
    'total_words': len(word_map),
    'new_words_count': len(new_words),
    'coverage_rate': ...  # 词汇覆盖率
}
```

##### 改动 7: 增强命令行接口
```python
# 第262-280行：支持指定用户等级
python label.py <subtitle.srt> [ecdict.csv] [user_level]
# 示例：python label.py video.srt ecdict.csv cet4
```

---

## 🔧 使用方法

### 方法 1: 作为命令行工具

```bash
# 基础用法（默认 CET4 等级）
python label.py subtitle.srt

# 指定词汇量等级
python label.py subtitle.srt ecdict.csv cet6

# 可选的等级: basic, cet4, cet6, toefl, ielts, gre, advanced
python label.py subtitle.srt ecdict.csv toefl
```

**输出示例**:
```
生成标签文件，包含 50 个字幕块，120 个单词
统计信息:
  - 总词汇数: 120
  - 生词数: 25
  - 词汇覆盖率: 79.17%

前 10 个生词:
  1. sophisticated (六级词汇) - 复杂的
  2. paradigm (GRE词汇) - 范例
  3. elaborate (托福词汇) - 详尽的
  ...
```

---

### 方法 2: 在 Python 代码中使用

```python
from label import Labeler

# 创建标注器，指定用户等级
labeler = Labeler(user_vocab_level='cet6')

# 处理字幕文件
result = labeler.process_subtitle_file('video.srt')

# 获取生词列表
new_words = result['new_words']
for word in new_words:
    print(f"{word['word']}: {word['translation']} ({word['difficulty']})")

# 获取统计信息
stats = result['statistics']
print(f"词汇覆盖率: {stats['coverage_rate']}%")
```

---

## 📊 输出 JSON 结构说明

### 完整输出结构

```json
{
  "source": "example.srt",
  "path": "/absolute/path/to/example.srt",

  "blocks": [
    {
      "index": 1,
      "start": "00:00:01,000",
      "end": "00:00:03,500",
      "text": "Hello, this is a sophisticated example.",
      "words": [
        {
          "original": "Hello",
          "entry": { /* 词库完整信息 */ },
          "is_new": false,          // ⭐ 新增：是否超纲
          "difficulty": "基础词汇"   // ⭐ 新增：难度标签
        },
        {
          "original": "sophisticated",
          "entry": { /* 词库完整信息 */ },
          "is_new": true,           // ⭐ 新增
          "difficulty": "六级词汇"   // ⭐ 新增
        }
      ]
    }
  ],

  "word_map": {
    "hello": {
      "entry": { /* 词库信息 */ },
      "is_new": false,              // ⭐ 新增
      "difficulty": "基础词汇",      // ⭐ 新增
      "occurrences": [              // ⭐ 新增：出现位置
        {
          "sentence_index": 1,
          "sentence_text": "Hello, this is a sophisticated example."
        }
      ]
    }
  },

  "new_words": [                    // ⭐ 新增：生词列表
    {
      "word": "sophisticated",
      "translation": "复杂的",
      "difficulty": "六级词汇",
      "first_occurrence": {
        "sentence_index": 1,
        "sentence_text": "Hello, this is a sophisticated example.",
        "timestamp": "00:00:01,000 --> 00:00:03,500"
      }
    }
  ],

  "statistics": {                   // ⭐ 新增：统计信息
    "total_words": 120,
    "new_words_count": 25,
    "coverage_rate": 79.17
  }
}
```

---

## 🧮 核心算法说明

### 1. 词汇难度判断算法

```python
def is_beyond_level(word, word_entry) -> bool:
    """判断单词是否超出用户词汇量"""

    # 第一步：检查常用词白名单
    if word in COMMON_WORDS:
        return False  # 常用词不标注

    # 第二步：检查词库标签（tag 字段）
    word_levels = parse_word_tags(word_entry['tag'])
    if word_levels:
        # 如果有任何一个等级超出用户水平，则标注为超纲
        for level in word_levels:
            if level not in user_covered_levels:
                return True
        return False

    # 第三步：无标签时使用词频判断
    bnc = int(word_entry['bnc'])
    threshold = get_threshold_for_user_level()
    return bnc > threshold
```

### 2. 词频阈值设定

| 用户等级 | BNC 词频阈值 | 说明 |
|---------|------------|------|
| BASIC   | 3000       | 基础词汇（约 3000 词） |
| CET4    | 5000       | 四级词汇（约 4500 词） |
| CET6    | 8000       | 六级词汇（约 6000 词） |
| TOEFL   | 12000      | 托福词汇（约 8000 词） |
| IELTS   | 12000      | 雅思词汇（约 8000 词） |
| GRE     | 20000      | GRE 词汇（约 12000 词） |

> BNC (British National Corpus) 数值越小表示词汇越常用

### 3. 难度标签生成逻辑

```
优先级: GRE > TOEFL/IELTS > CET6 > CET4 > BASIC

如果词汇同时属于多个等级，选择最高等级作为标签
例如：某词 tag="cet4 cet6 toefl" → 显示为"托福词汇"
```

---

## ✨ 技术亮点

### 1. 兼容性设计
- 优雅的模块导入（支持相对/绝对导入）
- 向后兼容：如果 vocab_level 模块不可用，功能自动降级但不报错

### 2. 双重判断机制
- **基于标签**：优先使用词库的 tag 字段（准确但覆盖不全）
- **基于词频**：当词汇无标签时，使用 BNC 词频判断（覆盖全但不够精确）

### 3. 层次化等级体系
- 高级等级自动包含低级（如 CET6 用户掌握 CET4 + BASIC 词汇）
- 支持未来扩展更多等级

### 4. 可扩展的常用词白名单
- 预留接口，可从外部文件加载高频词列表
- 减少不必要的标注，提升用户体验

---

## 🧪 测试验证

### 运行测试

```bash
cd D:\videolingo\videolingo\front\src\common\whisper
python test_vocab_level.py
```

### 测试覆盖

- ✅ 不同用户等级的词汇判断
- ✅ 标签解析（tag 字段）
- ✅ 词频判断（无标签词汇）
- ✅ 输出 JSON 结构验证

---

## 📈 业务价值

### 对用户的价值
1. **个性化学习体验**：根据自身水平看到针对性的生词标注
2. **降低学习负担**：已掌握的词不再干扰，专注于需要学习的内容
3. **精准评估材料难度**：通过词汇覆盖率快速判断视频是否适合当前水平

### 对产品的价值
1. **差异化竞争力**：市面上少有视频学习工具提供词汇分级功能
2. **提升留存率**：个性化体验增强用户粘性
3. **数据驱动**：为后续推荐系统提供数据支持

---

## 🔮 后续扩展方向

### 短期（1-2周）
- [ ] 扩充常用词白名单至 1000 词
- [ ] 添加用户自定义熟词表功能
- [ ] 支持导出生词本为 Anki 卡片格式

### 中期（1个月）
- [ ] 实现前端界面展示（高亮生词、悬浮显示释义）
- [ ] 添加词汇掌握度反馈（用户可标记"已掌握"）
- [ ] 统计学习曲线（词汇量增长追踪）

### 长期（3个月）
- [ ] 支持多语言（日语、韩语等）
- [ ] 智能推荐学习材料（根据用户词汇量推荐合适难度的视频）
- [ ] 集成记忆曲线算法（Spaced Repetition）

---

---

## 📝 更新日志

- ✅ 实现基于标签和词频的双重判断
- ✅ 支持 7 个词汇等级（BASIC → ADVANCED）
- ✅ 生成生词列表和统计信息
- ✅ 完整的测试用例

---

